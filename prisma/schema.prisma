generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String                       @id @default(cuid())
  email                      String                       @unique
  name                       String?
  password                   String
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  companyName                String?
  profileImage               String?
  profileImageId             String?
  city                       String?
  country                    String?
  dateOfBirth                DateTime?
  phoneNumber                String?
  streetAddress              String?
  twoFactorEnabled           Boolean                      @default(false)
  twoFactorSecret            String?
  twoFactorBackupCodes       String[]
  role                       Role                         @default(CLIENT)
  idNumber                   String?
  luxorSubaccountName        String?
  companyUrl                 String?
  isDeleted                  Boolean                      @default(false)
  auditLogs                  AuditLog[]                   @relation("auditLogs")
  costPayments               CostPayment[]
  pricingCreated             CustomerPricingConfig[]      @relation("pricingConfigsCreated")
  pricingUpdated             CustomerPricingConfig[]      @relation("pricingConfigsUpdated")
  pricingConfigs             CustomerPricingConfig[]      @relation("pricingConfigs")
  createdGroups              Group[]
  hardwareProcurementHistory HardwareProcurementHistory[]
  invoicesCreated            Invoice[]                    @relation("invoicesCreated")
  invoicesUpdated            Invoice[]                    @relation("invoicesUpdated")
  invoices                   Invoice[]                    @relation("invoices")
  createdMinerHistory        MinerOwnershipHistory[]      @relation("createdBy")
  ownedMinerHistory          MinerOwnershipHistory[]      @relation("owner")
  miners                     Miner[]
  recurringCreated           RecurringInvoice[]           @relation("recurringInvoicesCreated")
  recurringUpdated           RecurringInvoice[]           @relation("recurringInvoicesUpdated")
  recurringInvoices          RecurringInvoice[]           @relation("recurringInvoices")
  blacklisted                TokenBlacklist[]
  activities                 UserActivity[]
  paymentDetailsUpdates      PaymentDetails[]
  invoicedAmount             Decimal                      @default(4250) @db.Decimal(12, 2)

  @@index([isDeleted])
  @@map("users")
}

model TokenBlacklist {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([token])
  @@map("token_blacklist")
}

model UserActivity {
  id        String   @id @default(cuid())
  userId    String
  type      String
  ipAddress String
  userAgent String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("user_activities")
}

model PaybackConfig {
  id                     Int      @id @default(autoincrement())
  hostingCharges         Decimal  @db.Decimal(10, 5)
  monthlyInvoicingAmount Decimal  @db.Decimal(12, 2)
  powerConsumption       Decimal  @db.Decimal(10, 4)
  machineCapitalCost     Decimal  @db.Decimal(12, 2)
  poolCommission         Decimal  @db.Decimal(5, 2)
  s21proHashrateStockOs  Decimal  @db.Decimal(10, 2)
  s21proHashrateLuxos    Decimal  @db.Decimal(10, 2)
  breakevenBtcPrice      Decimal  @default(63500) @db.Decimal(12, 2)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("payback_config")
}

model Hardware {
  id                 String                       @id @default(cuid())
  model              String                       @unique
  powerUsage         Float
  hashRate           Decimal
  createdAt          DateTime                     @default(now())
  updatedAt          DateTime                     @updatedAt
  quantity           Int                          @default(1)
  isDeleted          Boolean                      @default(false)
  procurementHistory HardwareProcurementHistory[]
  miners             Miner[]

  @@index([isDeleted])
  @@map("hardware")
}

model Miner {
  id               String                  @id @default(cuid())
  name             String
  status           String                  @default("DEPLOYMENT_IN_PROGRESS")
  userId           String
  spaceId          String
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  hardwareId       String
  isDeleted        Boolean                 @default(false)
  ownershipHistory MinerOwnershipHistory[]
  rateHistory      MinerRateHistory[]
  hardware         Hardware                @relation(fields: [hardwareId], references: [id])
  space            Space                   @relation(fields: [spaceId], references: [id])
  user             User                    @relation(fields: [userId], references: [id])

  @@unique([name, userId])
  @@index([hardwareId])
  @@index([isDeleted])
  @@map("miners")
}

model MinerRateHistory {
  id           String   @id @default(cuid())
  minerId      String
  rate_per_kwh Decimal  @db.Decimal(10, 6)
  createdAt    DateTime @default(now())
  miner        Miner    @relation(fields: [minerId], references: [id], onDelete: Cascade)

  @@index([minerId])
  @@index([minerId, createdAt(sort: Desc)])
  @@map("miner_rate_history")
}

model Space {
  id            String   @id @default(cuid())
  name          String
  location      String
  capacity      Int
  powerCapacity Float
  status        String   @default("AVAILABLE")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  miners        Miner[]

  @@map("spaces")
}

model CostPayment {
  id              String           @id @default(cuid())
  userId          String
  invoiceId       String?
  amount          Float
  consumption     Float
  type            PaymentType
  createdAt       DateTime         @default(now())
  narration       String?
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoice         Invoice?  @relation("invoiceCostPayments", fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([invoiceId])
  @@index([createdAt])
  @@map("cost_payments")
}

model MinerOwnershipHistory {
  id          String   @id @default(cuid())
  ownerId     String
  createdById String
  createdAt   DateTime @default(now())
  minerId     String?
  createdBy   User     @relation("createdBy", fields: [createdById], references: [id], onDelete: Cascade)
  miner       Miner?   @relation(fields: [minerId], references: [id], onDelete: Cascade)
  owner       User     @relation("owner", fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([minerId])
  @@index([ownerId])
  @@index([createdById])
  @@map("miner_ownership_history")
}

model HardwareProcurementHistory {
  id          String   @id @default(cuid())
  hardwareId  String
  quantity    Int
  createdById String
  createdAt   DateTime @default(now())
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  hardware    Hardware @relation(fields: [hardwareId], references: [id], onDelete: Cascade)

  @@index([hardwareId])
  @@index([createdById])
  @@map("hardware_procurement_history")
}

model Group {
  id                    String            @id @default(cuid())
  name                  String            @db.VarChar(255)
  relationshipManager   String?           @db.VarChar(255)
  email                 String?           @db.VarChar(255)
  description           String?
  isActive              Boolean           @default(true)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  createdBy             String
  subaccounts           GroupSubaccount[]
  creator               User              @relation(fields: [createdBy], references: [id])

  @@index([isActive])
  @@map("groups")
}

model GroupSubaccount {
  id             String   @id @default(cuid())
  groupId        String
  subaccountName String   @unique
  addedAt        DateTime @default(now())
  addedBy        String
  group          Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([subaccountName])
  @@map("group_subaccounts")
}

model Invoice {
  id                   String                @id @default(cuid())
  invoiceNumber        String                @unique
  userId               String
  totalMiners          Int
  unitPrice            Decimal               @db.Decimal(10, 2)
  totalAmount          Decimal               @db.Decimal(12, 2)
  status               InvoiceStatus
  invoiceGeneratedDate DateTime
  issuedDate           DateTime?
  dueDate              DateTime
  paidDate             DateTime?
  createdBy            String
  updatedBy            String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  notifications        InvoiceNotification[] @relation("invoiceNotifications")
  costPayments         CostPayment[]         @relation("invoiceCostPayments")
  confirmoPayment      ConfirmoPayment?
  createdByUser        User                  @relation("invoicesCreated", fields: [createdBy], references: [id])
  updatedByUser        User?                 @relation("invoicesUpdated", fields: [updatedBy], references: [id])
  user                 User                  @relation("invoices", fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@index([createdAt])
  @@index([invoiceNumber])
  @@map("invoices")
}

model RecurringInvoice {
  id                String    @id @default(cuid())
  userId            String
  dayOfMonth        Int
  unitPrice         Decimal?  @db.Decimal(10, 2)
  startDate         DateTime
  endDate           DateTime?
  isActive          Boolean   @default(true)
  lastGeneratedDate DateTime?
  createdBy         String
  updatedBy         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdByUser     User      @relation("recurringInvoicesCreated", fields: [createdBy], references: [id])
  updatedByUser     User?     @relation("recurringInvoicesUpdated", fields: [updatedBy], references: [id])
  user              User      @relation("recurringInvoices", fields: [userId], references: [id])

  @@index([userId])
  @@index([isActive])
  @@index([dayOfMonth])
  @@index([startDate])
  @@map("recurring_invoices")
}

model CustomerPricingConfig {
  id               String    @id @default(cuid())
  userId           String
  defaultUnitPrice Decimal   @db.Decimal(10, 2)
  effectiveFrom    DateTime
  effectiveTo      DateTime?
  createdBy        String
  updatedBy        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  createdByUser    User      @relation("pricingConfigsCreated", fields: [createdBy], references: [id])
  updatedByUser    User?     @relation("pricingConfigsUpdated", fields: [updatedBy], references: [id])
  user             User      @relation("pricingConfigs", fields: [userId], references: [id])

  @@unique([userId, effectiveFrom])
  @@index([userId])
  @@index([effectiveFrom])
  @@index([effectiveTo])
  @@map("customer_pricing_config")
}

model AuditLog {
  id          String      @id @default(cuid())
  action      AuditAction
  entityType  String
  entityId    String
  userId      String
  changes     Json?
  description String
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())
  user        User        @relation("auditLogs", fields: [userId], references: [id])

  @@index([entityId])
  @@index([entityType])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

model InvoiceNotification {
  id               String             @id @default(cuid())
  invoiceId        String
  notificationType NotificationType
  sentTo           String
  ccEmails         String?
  sentAt           DateTime
  isRead           Boolean            @default(false)
  openedAt         DateTime?
  status           NotificationStatus
  failureReason    String?
  retryCount       Int                @default(0)
  nextRetryAt      DateTime?
  createdAt        DateTime           @default(now())
  invoice          Invoice            @relation("invoiceNotifications", fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([status])
  @@index([sentTo])
  @@index([createdAt])
  @@index([sentAt])
  @@map("invoice_notifications")
}

enum Role {
  ADMIN
  CLIENT
  SUPER_ADMIN
}

enum PaymentType {
  PAYMENT
  ELECTRICITY_CHARGES
  ADJUSTMENT
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  OVERDUE
  PAID
  CANCELLED
  REFUNDED
}

enum AuditAction {
  INVOICE_CREATED
  INVOICE_UPDATED
  INVOICE_ISSUED
  INVOICE_SENT_TO_CUSTOMER
  INVOICE_CANCELLED
  INVOICE_PAID
  PAYMENT_ADDED
  PAYMENT_REMOVED
  PAYMENT_REFUNDED
  RECURRING_INVOICE_CREATED
  RECURRING_INVOICE_UPDATED
  RECURRING_INVOICE_DELETED
  RECURRING_INVOICE_PAUSED
  RECURRING_INVOICE_RESUMED
  PRICING_CONFIG_CREATED
  PRICING_CONFIG_UPDATED
  PRICING_CONFIG_ARCHIVED
  EMAIL_SENT
  EMAIL_FAILED
  EMAIL_RETRY
}

enum NotificationType {
  INVOICE_ISSUED
  PAYMENT_REMINDER
  OVERDUE_REMINDER
  PAYMENT_RECEIVED
  INVOICE_VIEWED
  INVOICE_CANCELLED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
  UNSUBSCRIBED
}
// Payment Details for Invoice PDF - Admin configurable settings
model PaymentDetails {
  id                      String    @id @default(cuid())
  
  // Company Information
  companyName             String    @default("BitFactory.AE")
  companyLegalName        String    @default("Higgs Computing Limited")
  companyLocation         String    @default("Ras Al Khaimah, UAE")
  machineHostingLocation  String    @default("Addis Ababa, Ethiopia")
  logoBase64              String?   // Base64 encoded logo image
  
  // Payment Options
  paymentOption1Title     String    @default("OPTION 1:")
  paymentOption1Details   String    @default("USDT (Tron): TLNjcYnokhA1UcVsYVKjdeh9HzMS6GQJNe")
  
  paymentOption2Title     String    @default("OPTION 2:")
  paymentOption2Details   String    @default("USDC (ETH): 0x722460E434013075E8cF8dd42c8854424aFa336E")
  
  paymentOption3Title     String    @default("OPTION 3:")
  paymentOption3Details   String    // Bank details (multiline)
  
  // Billing Contact Information
  billingInquiriesEmail   String    @default("invoices@bitfactory.ae")
  billingInquiriesWhatsApp String   @default("+971-52-6062903")
  
  // Support Contact Information
  supportEmail            String    @default("support@bitfactory.ae")
  supportWhatsApp         String    @default("+971-52-6062903")
  
  // Confirmo Integration Settings
  confirmoEnabled           Boolean   @default(false)
  confirmoSettlementCurrency String?  @default("USDC")
  confirmoReturnUrl         String?   @default("https://my.bitfactory.ae/invoices/payment-success")
  
  // Metadata
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  updatedBy               String?
  updatedByUser           User?     @relation(fields: [updatedBy], references: [id], onDelete: SetNull)
  
  @@index([id])
  @@index([updatedBy])
}

model ConfirmoPayment {
  id                String                   @id @default(cuid())
  
  // Link to Invoice
  invoiceId         String                   @unique
  invoice           Invoice                  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  // Confirmo Details
  confirmoInvoiceId String                   @unique
  paymentUrl        String
  amount            Decimal                  @db.Decimal(12, 2)
  currency          String                   @default("USD")
  settlementCurrency String?                 @default("USDC")
  
  // Status Tracking
  status            ConfirmoPaymentStatus    @default(PENDING)
  
  // Webhook Data (populated after payment)
  paidAmount        Decimal?                 @db.Decimal(12, 8)
  paidCurrency      String?
  transactionHash   String?
  confirmedAt       DateTime?
  
  // Metadata
  customerEmail     String
  notifyEmail       String
  reference         String
  
  // Timestamps
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  expiresAt         DateTime?
  
  @@index([confirmoInvoiceId])
  @@index([status])
  @@index([invoiceId])
  @@map("confirmo_payments")
}

enum ConfirmoPaymentStatus {
  PENDING
  PROCESSING
  CONFIRMED
  COMPLETED
  EXPIRED
  CANCELLED
  FAILED
}